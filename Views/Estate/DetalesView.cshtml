@model List<Comments>
    @using System.Security.Claims
    @inject UserManager<AppUser> _userManager;
        @inject IReplaies rep;
@{
    var user = await _userManager.GetUserAsync(User);
    var photo = Convert.ToBase64String(user.ProfilePicture);

        }

        @section Styles{

        <!-- Fuentes de Google -->
        <link href='https://fonts.googleapis.com/css?family=Roboto:400,700' rel='stylesheet' type='text/css'>
        <!-- Iconos -->
        <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
        <link rel="stylesheet" href="./style.css">

        <style>
            /**
* Oscuro: #283035
* Azul: #03658c
* Detalle: #c7cacb
* Fondo: #dee1e3
----------------------------------*/

            .closed {
                display: none !important;

            }

            .closedReplaies {
                display: none !important;
            }

            .closedForm {
                display: none !important;
            }

            * {
                margin: 0;
                padding: 0;
                -webkit-box-sizing: border-box;
                -moz-box-sizing: border-box;
                box-sizing: border-box;
                text-align: right;
            }

            a {
                color: #03658c;
                text-decoration: none;
            }

            ul {
                list-style-type: none;
            }

            body {
                font-family: 'Roboto', Arial, Helvetica, Sans-serif, Verdana;
                background: #dee1e3;
            }

            /** ====================
* Lista de Comentarios
=======================*/
            .comments-container {
                margin: 60px auto 15px;
                width: 768px;
            }

            .comments-container h1 {
                font-size: 36px;
                color: #283035;
                font-weight: 400;
            }

            .comments-container h1 a {
                font-size: 18px;
                font-weight: 700;
            }

            .comments-list {
                margin-top: 30px;
                position: relative;
            }

            /**
* Lineas / Detalles
-----------------------*/
            .comments-list:before {
                content: '';
                width: 2px;
                height: 100%;
                background: #c7cacb;
                position: absolute;
                right: 32px;
                top: 0;
            }

            .comments-list:after {
                content: '';
                position: absolute;
                background: #c7cacb;
                bottom: 0;
                left: 27px;
                width: 7px;
                height: 7px;
                border: 3px solid #dee1e3;
                -webkit-border-radius: 50%;
                -moz-border-radius: 50%;
                border-radius: 50%;
            }

            .reply-list:before,
            .reply-list:after {
                display: none;
            }

            .reply-list li:before {
                content: '';
                width: 60px;
                height: 2px;
                background: #c7cacb;
                position: absolute;
                top: 25px;
                right: -77px;
            }


            .comments-list li {
                margin-bottom: 15px;
                display: block;
                position: relative;
            }

            .comments-list li:after {
                content: '';
                display: block;
                clear: both;
                height: 0;
                width: 0;
            }

            .reply-list {

                clear: both;
                margin-top: 15px;
                margin-right: 112px;
            }

            /**
* Avatar
---------------------------*/
            .comments-list .comment-avatar {
                margin-left: 27px;
                width: 65px;
                height: 65px;
                position: relative;
                z-index: 99;
                float: left;
                border: 3px solid #FFF;
                -webkit-border-radius: 4px;
                -moz-border-radius: 4px;
                border-radius: 4px;
                -webkit-box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
                -moz-box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
                box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
                overflow: hidden;
            }

            .comments-list .comment-avatar img {
                width: 100%;
                height: 100%;
            }

            .reply-list .comment-avatar {
                width: 50px;
                height: 50px;
            }

            .comment-main-level {
                display: flex;
            }

            .comment-main-level:after {
                content: '';
                width: 0;
                height: 0;
                display: block;
                clear: both;
            }

            /**
* Caja del Comentario
---------------------------*/
            .comments-list .comment-box {
                width: 680px;
                float: right;
                position: relative;
                -webkit-box-shadow: 0 1px 1px rgba(0, 0, 0, 0.15);
                -moz-box-shadow: 0 1px 1px rgba(0, 0, 0, 0.15);
                box-shadow: 0 1px 1px rgba(0, 0, 0, 0.15);
            }

            .comments-list .comment-box:before,
            .comments-list .comment-box:after {
                content: '';
                height: 0;
                width: 0;
                position: absolute;
                display: block;
                border-width: 14PX;
                border-style: solid;
                border-color: #dee1e3 #dee1e3 #dee1e3 #ffffff99;
                top: 0;
                right: -27PX;
            }


            .comments-list .comment-box:before {
                border-width: 11px 13px 11px 0;
                border-color: transparent rgba(0, 0, 0, 0.05);
                left: -12px;
            }

            .reply-list .comment-box {
                width: 610px;
            }

            .comment-box .comment-head {
                background: #FCFCFC;
                padding: 10px 12px;
                border-bottom: 1px solid #E5E5E5;
                overflow: hidden;
                -webkit-border-radius: 4px 4px 0 0;
                -moz-border-radius: 4px 4px 0 0;
                border-radius: 4px 4px 0 0;
                display: flex;
                align-items: baseline;
                justify-content: space-between;
            }

            .comment-box .comment-head i {
                float: right;
                margin-left: 14px;
                position: relative;
                top: 2px;
                color: #A6A6A6;
                cursor: pointer;
                -webkit-transition: color 0.3s ease;
                -o-transition: color 0.3s ease;
                transition: color 0.3s ease;
            }

            .comment-box .comment-head i:hover {
                color: #03658c;
            }

            .comment-box .comment-name {
                color: #283035;
                font-size: 14px;
                font-weight: 700;
                float: left;
                margin-right: 10px;
            }

            .comment-box .comment-name a {
                color: #283035;
            }

            .comment-box .comment-head span {
                float: left;
                color: #999;
                font-size: 13px;
                position: relative;
                top: 1px;
            }

            .comment-box .comment-content {
                background: #FFF;
                padding: 12px;
                font-size: 15px;
                color: #595959;
                -webkit-border-radius: 0 0 4px 4px;
                -moz-border-radius: 0 0 4px 4px;
                border-radius: 0 0 4px 4px;
            }

            .comment-box .comment-name.by-author,
            .comment-box .comment-name.by-author a {
                color: #03658c;
            }

            .comment-box .comment-name.by-author:after {
                content: 'autor';
                background: #03658c;
                color: #FFF;
                font-size: 12px;
                padding: 3px 5px;
                font-weight: 700;
                margin-left: 10px;
                -webkit-border-radius: 3px;
                -moz-border-radius: 3px;
                border-radius: 3px;
            }

            .showRepShow {
                display: flex;
                justify-content: end;

                margin-top: -6px;
                margin-left: 23px;
            }

            .show {
                display: flex;
                justify-content: end;
            }

            .witeComment {
                display: flex;
                justify-content: end;
                margin-bottom: 16px;
            }

            .writeRep {
                display: flex;
                justify-content: end;
                margin-bottom: 16px;
                margin-top: 16px;
                margin-left: 182px;

            }

            .formrepla {
                display: flex;
                flex-direction: column;
            }

            .textrep {
                width: 50%;
                margin: auto;
            }


            .loginPlac {
                display: flex !important;
                justify-content: center !important;
            }

            /** =====================
* Responsive
========================*/
            @@media only screen and (max-width: 766px) {
                .comments-container {
                    width: 480px;
                }

                .comments-list .comment-box {
                    width: 390px;
                }

                .reply-list .comment-box {
                    width: 320px;
                }
            }
        </style>

        }



        <!-- partial:index.partial.html -->
        <!-- Contenedor Principal -->
        <div class="comments-container">
            <span id="loginPlease" style="display:none;"> عليك تسجيل الدخول اولا <a href="/Identity/Account/Login">
                    تسجيل الدخول</a></span>
            <form method="">
                <div class="">
                    <textarea id="bodytextarea" style="width:100%" rows="3"
                        placeholder="اكتب هنا التعليق...."></textarea>

                    <a class="witeComment" onclick="createComments(30)"> إضافة هنا

                        <span id="errorEmpty"></span>
                    </a>



                </div>

            </form>

            <p class="text-danger d-none added">تم إضافة التعليق بنجاح</p>

            <h1>التعليقات </h1>

            <ul id="comments-list" class="comments-list ">
                @{
                for (int i = 0; i < Model.Count(); i++) { <li class="@((i!=0 && i!=1) ?" closed":"") @i">
                                                                                            <div class="comment-main-level">

                                                                                                <div class="comment-avatar"><img
                                                                                                        src="data:image/*;base64,@(Convert.ToBase64String(Model[i].AppUser.ProfilePicture))"
                                                                                                        alt=""></div>

                                                                                                <div class="comment-box">
                                                                                                    <div class="comment-head">
                                                                                                        <h6 class="comment-name"><a
                                                                                                                href="http://creaticode.com/blog">@Model[i].AppUser.FirstName
                                                                                                                @Model[i].AppUser.LastName </a></h6>
                                                                                                      
                                                                                                   
                                                                                                              <i class="fa fa-reply"onclick="ShowFormReplay(@i)" >  </i>
                                                                                                      
                                                                                                      
                                                                                                    </div>
                                                                                                    <div class="comment-content">
                                                                                                        <p>@Model[i].Body</p>
                                                                                                    </div>
                                                                                                </div>
                                                                                            </div>
                                                                                            <!-- Respuestas de los comentarios -->
                                                                                            @{
                    List<Replaies> lst=await rep.GetCommentReplies(Model[i].Id);

                        if(lst != null)
                        {
                        long q= -1;
                                                                                                                                                                        <ul class="comments-list reply-list ul-@Model[i].Id">

                                                                                                                                                                            @{
for (int x = 0; x < lst.Count(); x++) { q=lst[x].Id; <li
                                                                                                                        class=" closedReplaies-@Model[i].Id closedReplaies ">
                                                                                                                        <div class="comment-main-level">

                                                                                                                        <div class="comment-avatar"><img
                                                                                                                        src="data:image/*;base64,@(Convert.ToBase64String(lst[x].AppUser.ProfilePicture))"
                                                                                                                        alt=""></div>

                                                                                                                        <div class="comment-box">
                                                                                                                        <div class="comment-head">
                                                                                                                        <h6 class="comment-name"><a
                                                                                                                                href="http://creaticode.com/blog">@lst[x].AppUser.FirstName
                                                                                                                                @lst[x].AppUser.LastName </a></h6>

                                                                                                                        </div>
                                                                                                                        <div class="comment-content">
                                                                                                                        <p style="width:0px">@lst[x].body</p>
                                                                                                                        </div>
                                                                                                                        </div>
                                                                                                                        </div>

                                                                                                                        </li>


                                }
                                                                                                                                                                                }


                                                                                                                                                                        </ul>

                                                                                                                                                                        <div class="showRepShow" style="display: @((q==-1 ) ?" none":"") "  ><a class=" x-@Model[i].Id"
                                                                                                                                                                            onclick="showReplaies(@Model[i].Id)">عرض الردود</a></div>

                        }

                                                                                                }
                                                                                                </li>

                                                                                                <form method="" id="form-@i" class="closedForm">
                                                                                                    <span class="loginPlac" id="loginPlease-@Model[i].Id" style="display:none !important;"> عليك تسجيل
                                                                                                        الدخول اولا <a href="/Identity/Account/Login"> تسجيل الدخول</a></span>
                                                                                                    <div class="formrepla">
                                                                                                        <textarea id="bodytextarea-@Model[i].Id" class="textrep" rows="3"
                                                                                                            placeholder="اكتب هنا الرد...."></textarea>

                                                                                                        <a class="writeRep" onclick="createRepaliy(@Model[i].Id)"> إضافة هنا
                                                                                                            <span class="errorrep" id="errorEmpty-@Model[i].Id"></span>


                                                                                                        </a>


                                                                                                    </div>

                                                                                                </form>



                        }
                        }


            </ul>
            <div class="show"><a>عرض المزيد</a></div>
        </div>


        <!-- partial -->



        @section Scripts{



        <script type="text/javascript">

            const showContainers = document.querySelectorAll(".closed");


            let sh = document.getElementsByClassName('show')[0];

            sh.addEventListener('click', function () {
                if (sh.innerHTML == "عرض أقل") {
                    sh.innerHTML = "عرض المزيد"
                }

                else {
                    sh.innerHTML = "عرض أقل"
                }
                showContainers.forEach((child) => child.classList.toggle("closed"));

            })
            function showReplaies(id) {


                const showContainers1 = document.querySelectorAll(`.closedReplaies-${id}`);

                console.log(showContainers1)


                let shs = document.getElementsByClassName(`x-${id}`)[0];
                if (shs.innerHTML == "عرض الردود") {
                    shs.innerHTML = "إخفاء الردود"
                }

                else {
                    shs.innerHTML = "عرض الردود"
                }
                showContainers1.forEach((child) => child.classList.toggle("closedReplaies"));

            }






            function hicreateElement(name,photo, txt) {



                console.log('hicreateElement');

                var li = document.createElement('li');

               



                var div1 = document.createElement('div');
                div1.classList.add('comment-main-level');

                


                var divAvatar = document.createElement('div');
                divAvatar.classList.add('comment-avatar');

                var image = document.createElement('img');
              

                image.src = "data:image/*;base64,"+ photo;
               
         

               

               



                var div2 = document.createElement('div');
                div2.classList.add("comment-box");
                divAvatar.appendChild(image);
                 
                div1.appendChild(divAvatar);
                var div3 = document.createElement('div');
                div3.classList.add('comment-head');

                var h6 = document.createElement('h6');

                h6.classList.add('comment-name');


                var Ah6 = document.createElement('a');
                Ah6.href = "http://creaticode.com/blog";

                Ah6.innerHTML = name;




               
                var replay1 = document.createElement('i');
                replay1.classList.add('fa');
                replay1.classList.add('fa-reply');


                h6.appendChild(Ah6);
                div3.appendChild(h6);
                div3.appendChild(replay1);

                var div4 = document.createElement('div');
                div4.classList.add('comment-content');
                var p = document.createElement('p');
                p.innerHTML = txt;
                  li.appendChild(div1);
                  div1.appendChild(div2);
                div4.appendChild(p);

                div2.appendChild(div3);
                div2.appendChild(div4);
               
              


                var ul = document.getElementById('comments-list');
                ul.appendChild(li);



            }



            function createComments(idestate) {
                var txt = document.getElementById('bodytextarea').value;
                var errorEmpty = document.getElementById('errorEmpty');
                var loginPlease = document.getElementById('loginPlease');

                var added = document.getElementsByClassName('added')[0];

                if (txt == "") {
                    errorEmpty.innerHTML = "أدخل التعليق "

                    return;
                }

                else if (txt.length > 50) {
                     errorEmpty.innerHTML = "الحد الاقصى 50 حرف "

                    return;
                }
                $.ajax({
                    method: 'Get',
                    url: `/Estate/AddComment`,
                    data: { id: idestate, body: txt },

                    success: function (data) {
                        if (data.status == "Insert") {
                            hicreateElement(data.name,data.photo, txt);
                            added.classList.remove('d-none')
                        }

                        else if (data.status == "Disconnected") {

                            loginPlease.style.display = "block"


                        }
                    }
                });




                console.log(txt, idestate);





            }
        </script>

        <script>
    
            function ShowFormReplay(i) {

                console.log('createRepalys');

                let formRep = document.getElementById(`form-${i}`);

                formRep.classList.toggle("closedForm");


            }


            
</script>

<script>
            function createRepaliy(id) {

                console.log('hiEveryOne')

                var txt = document.getElementById(`bodytextarea-${id}`).value;


                var errorEmpty = document.getElementById(`errorEmpty-${id}`);
                var loginPlease = document.getElementById(`loginPlease-${id}`);


                if (txt == "") {
                    errorEmpty.innerHTML = "أدخل الرد ";

                    return;
                }

                else if (txt.length > 50) {
                     errorEmpty.innerHTML = "الحد الاقصى 50 حرف "

                    return;
                }

                $.ajax({
                    method: 'Get',
                    url: `/Estate/AddReplay`,
                    data: { id: id, body: txt },

                    success: function (data) {
                        if (data.status == "Insert") {

                            hicreateElementRep(data.name,data.photo,id, txt);


                        }

                        else if (data.status == "Disconnected") {

                            loginPlease.style.display = "block"

                        }
                    }
                });


            }

</script>

        <script>



           

            function hicreateElementRep(name ,photo,id, txt) {
                var li = document.createElement('li');
                li.classList.add(`closedReplaies-${id}`);


                var divs = document.createElement('div');
                divs.classList.add('comment-main-level');

                var divs1 = document.createElement('div');
                divs1.classList.add('comment-avatar');

                var imagex = document.createElement('img');

                imagex.src = "data:image/*;base64,"+photo;
                divs1.appendChild(imagex);

                var divs2 = document.createElement('div');
                divs2.classList.add('comment-box');


                var divs3 = document.createElement('div');
                divs3.classList.add('comment-head');

                divs2.appendChild(divs3);

                var h6 = document.createElement('h6');
                h6.classList.add('comment-name');

                var a = document.createElement('a');


                h6.textContent = name;
                h6.appendChild(a);

                divs3.appendChild(h6);
                var divs4 = document.createElement('div');
                divs4.classList.add('comment-content');

                divs4.innerHTML = txt;

                divs2.appendChild(divs4);

                divs.appendChild(divs1);
                divs.appendChild(divs2);

                li.appendChild(divs);


                var ul = document.getElementsByClassName(`ul-${id}`)[0];



                ul.appendChild(li);






            }

        </script>

      


        }